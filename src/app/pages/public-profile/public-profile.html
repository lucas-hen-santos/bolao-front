<app-navbar></app-navbar>

<div class="min-h-screen bg-pattern-dark p-4 pb-20 bg-fixed">
  
  @if (isLoading) {
    <div class="flex justify-center items-center h-[80vh]">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-racing-red"></div>
    </div>
  } @else if (user) {
    <div class="max-w-4xl mx-auto space-y-8 pt-10 animate-slide-up">
      
      <div class="relative rounded-3xl overflow-hidden shadow-2xl border border-gray-800">
        <div class="absolute inset-0 bg-gradient-to-r from-gray-900 via-black to-racing-dark"></div>
        <div class="absolute inset-0 opacity-20" 
             [style.background]="user.team ? 'linear-gradient(135deg, ' + user.team.colors[0] + ', transparent)' : ''"></div>
        
        <div class="relative z-10 p-8 md:p-10 flex flex-col md:flex-row items-center gap-8">
          
          <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-white/10 overflow-hidden bg-black shadow-2xl relative shrink-0">
            @if (user.photo) {
              <img [src]="getPhotoUrl(user.photo)" class="w-full h-full object-cover">
            } @else {
              <div class="w-full h-full flex items-center justify-center text-6xl font-bold text-gray-700 bg-gray-900">
                {{ userInitial }}
              </div>
            }
            @if (user.team) {
              <div class="absolute bottom-2 right-2 w-10 h-10 bg-white p-1 rounded-full shadow-lg border border-gray-300" title="{{ user.team.name }}">
                <img [src]="getPhotoUrl(user.team.logo)" class="w-full h-full object-contain">
              </div>
            }
          </div>

          <div class="text-center md:text-left flex-1">
            <div class="flex flex-col md:flex-row items-center gap-4 mb-2">
              <h1 class="text-4xl md:text-5xl font-black text-white italic uppercase tracking-tighter leading-none">{{ user.name }}</h1>
              
              @if (currentUser && currentUser.id !== user.id) {
                <button (click)="challengeUser()" 
                        [disabled]="isChallenging"
                        class="px-6 py-2 rounded-full font-bold uppercase text-xs tracking-widest shadow-lg transition-all transform hover:scale-105 flex items-center gap-2 border"
                        [ngClass]="confirmChallenge ? 'bg-yellow-600 hover:bg-yellow-500 border-yellow-400 text-white animate-pulse' : 'bg-purple-600 hover:bg-purple-500 border-purple-400/50 text-white'">
                  <span>{{ confirmChallenge ? '‚ö†Ô∏è' : '‚öîÔ∏è' }}</span> 
                  {{ isChallenging ? 'Enviando...' : (confirmChallenge ? 'Confirmar?' : 'Desafiar') }}
                </button>
              }
            </div>
            
            <div class="flex flex-wrap justify-center md:justify-start gap-4 mb-4">
              @if (user.team) {
                <a [routerLink]="['/t', user.team.id]" class="px-3 py-1 rounded bg-white/10 border border-white/20 text-white text-xs font-bold uppercase tracking-wider hover:bg-white/20 transition-colors cursor-pointer">
                  {{ user.team.name }}
                </a>
              } @else {
                <span class="px-3 py-1 rounded bg-gray-800 border border-gray-700 text-gray-500 text-xs font-bold uppercase tracking-wider">
                  Sem Equipe
                </span>
              }
              <span class="px-3 py-1 rounded bg-racing-red/20 border border-racing-red/40 text-racing-red text-xs font-bold uppercase tracking-wider">
                Desde {{ user.joined_at | date:'yyyy' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass-panel p-6 text-center">
          <span class="text-4xl font-black text-white block">{{ user.stats.season_rank }}</span>
          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Ranking Atual</span>
        </div>
        <div class="glass-panel p-6 text-center">
          <span class="text-4xl font-black text-white block">{{ user.stats.season_points }}</span>
          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Pts Temporada</span>
        </div>
        <div class="glass-panel p-6 text-center">
          <span class="text-4xl font-black text-white block">{{ user.stats.races }}</span>
          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">GPs Disputados</span>
        </div>
        <div class="glass-panel p-6 text-center">
          <span class="text-4xl font-black text-white block">{{ user.stats.career_points }}</span>
          <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Pts Carreira</span>
        </div>
      </div>

      @if (user.stats.season_history && user.stats.season_history.length > 0) {
        <div class="glass-panel p-6">
          <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-6 border-l-4 border-racing-red pl-2">
            Evolu√ß√£o na Pista
          </h3>
          <div class="flex items-end justify-between gap-2 h-32 w-full">
            @for (race of user.stats.season_history; track $index) {
              <div class="flex-1 flex flex-col justify-end group">
                <div class="bg-gray-700 w-full rounded-t hover:bg-racing-red transition-all duration-300 relative"
                     [style.height]="(race.points * 5) + '%'" 
                     style="min-height: 4px; max-height: 100%;">
                   <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-white text-black text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                     {{ race.points }}
                   </div>
                </div>
                <div class="text-[9px] text-gray-500 text-center mt-2 truncate w-full overflow-hidden">{{ race.race }}</div>
              </div>
            }
          </div>
        </div>
      }

      @if (rivalryStats.total > 0) {
        <div class="glass-panel p-6 animate-slide-up border-t border-fuchsia-500/30" style="animation-delay: 0.1s;">
          <div class="flex justify-between items-end mb-6">
            <h3 class="text-white font-bold uppercase italic text-lg border-l-4 border-fuchsia-500 pl-2">
              Mata-Mata
            </h3>
            <span class="text-xs font-mono text-gray-400">{{ rivalryStats.total }} Lutas</span>
          </div>

          <div class="flex flex-col md:flex-row gap-8">
             
             <div class="flex-1 flex flex-col justify-center gap-3">
                <div class="flex items-center gap-3 text-xs font-bold">
                   <span class="w-8 text-green-500">VIT</span>
                   <div class="flex-1 h-4 bg-gray-800 rounded-full overflow-hidden">
                      <div class="h-full bg-green-500" [style.width]="(rivalryStats.wins / rivalryStats.total * 100) + '%'"></div>
                   </div>
                   <span class="w-8 text-right text-white">{{ rivalryStats.wins }}</span>
                </div>
                <div class="flex items-center gap-3 text-xs font-bold">
                   <span class="w-8 text-gray-400">EMP</span>
                   <div class="flex-1 h-4 bg-gray-800 rounded-full overflow-hidden">
                      <div class="h-full bg-gray-500" [style.width]="(rivalryStats.draws / rivalryStats.total * 100) + '%'"></div>
                   </div>
                   <span class="w-8 text-right text-white">{{ rivalryStats.draws }}</span>
                </div>
                <div class="flex items-center gap-3 text-xs font-bold">
                   <span class="w-8 text-red-500">DER</span>
                   <div class="flex-1 h-4 bg-gray-800 rounded-full overflow-hidden">
                      <div class="h-full bg-red-500" [style.width]="(rivalryStats.losses / rivalryStats.total * 100) + '%'"></div>
                   </div>
                   <span class="w-8 text-right text-white">{{ rivalryStats.losses }}</span>
                </div>
             </div>

             <div class="flex-1 space-y-2">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">√öltimos Confrontos</p>
                @for (duel of rivalryHistory.slice(0, 3); track duel.id) {
                   <div class="flex justify-between items-center bg-black/30 p-3 rounded border border-gray-800">
                      <span class="text-xs text-gray-300 font-bold">vs {{ getRivalName(duel) }}</span>
                      <span class="text-xs font-black px-2 py-0.5 rounded bg-black/50" [ngClass]="getRivalResultClass(duel)">
                        {{ getRivalResultLabel(duel) }}
                      </span>
                   </div>
                }
             </div>

          </div>
        </div>
      }

      <div class="space-y-4 animate-slide-up" style="animation-delay: 0.15s;">
        <div class="flex justify-between items-center pl-2 border-l-4 border-yellow-500">
          <h2 class="text-white font-bold uppercase italic text-xl">Sala de Trof√©us</h2>
          <span class="text-xs font-bold text-gray-500 bg-gray-900 px-3 py-1 rounded-full border border-gray-800">
            {{ userBadges.length }} / {{ allBadges.length }}
          </span>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          
          @for (item of displayedBadges; track item.id) {
            @let isUnlocked = !!item.earned_at;
            @let badgeDef = isUnlocked ? item.achievement : item;
            
            <div class="relative aspect-[3/4] rounded-xl border p-4 flex flex-col items-center justify-center text-center transition-all duration-300 group overflow-visible cursor-help"
                 [ngClass]="getBadgeStyle(badgeDef.color, !isUnlocked)">
              
              <div class="absolute bottom-full mb-3 w-48 bg-black/95 backdrop-blur-md text-white text-xs p-3 rounded-lg shadow-xl border border-gray-700 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-2 group-hover:translate-y-0 z-20 pointer-events-none">
                <p class="font-bold uppercase text-racing-red mb-1">{{ badgeDef.name }}</p>
                <p class="text-gray-300 leading-tight">{{ badgeDef.description }}</p>
                <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-black/95"></div>
              </div>

              <div class="absolute inset-0 bg-gradient-to-br opacity-50 transition-opacity group-hover:opacity-80 rounded-xl overflow-hidden pointer-events-none"
                   [ngClass]="getBadgeStyle(badgeDef.color, !isUnlocked)"></div>

              <div class="relative z-10 text-5xl mb-3 drop-shadow-xl transform transition-transform group-hover:scale-110 duration-300">
                {{ badgeDef.icon }}
              </div>

              <div class="relative z-10 flex flex-col items-center w-full">
                <h3 class="font-black italic uppercase text-xs leading-tight mb-1 truncate w-full px-1">
                  {{ badgeDef.name }}
                </h3>
                
                @if (isUnlocked) {
                  <p class="text-[9px] font-bold opacity-80 uppercase tracking-wider">
                    {{ item.earned_at | date:'dd/MM/yy' }}
                  </p>
                  @if (item.team) {
                    <div class="mt-2 inline-block bg-black/60 px-2 py-0.5 rounded text-[8px] uppercase font-bold border border-white/10 truncate max-w-full shadow-sm">
                      {{ item.team.name }}
                    </div>
                  }
                } @else {
                  <span class="text-[9px] opacity-50 font-bold uppercase tracking-widest mt-1 block border border-gray-700/50 px-2 py-0.5 rounded bg-black/20">
                    üîí Bloqueado
                  </span>
                }
              </div>
            </div>
          }
        </div>

        @if (hasMoreBadges) {
          <div class="text-center mt-6">
            <button (click)="toggleBadgesView()" 
                    class="group relative inline-flex items-center gap-2 px-6 py-2 rounded-full bg-gray-800 hover:bg-gray-700 text-white font-bold text-xs uppercase tracking-widest transition-all shadow-lg border border-gray-700 hover:border-gray-500">
              <span>{{ isBadgesExpanded ? 'Mostrar Menos' : 'Ver Todas' }}</span>
              <span class="text-lg group-hover:translate-y-0.5 transition-transform" *ngIf="!isBadgesExpanded">‚ñº</span>
              <span class="text-lg group-hover:-translate-y-0.5 transition-transform" *ngIf="isBadgesExpanded">‚ñ≤</span>
            </button>
          </div>
        }
      </div>

    </div>

  } @else {
    <div class="flex justify-center items-center h-[80vh] text-white">
      <div class="text-center">
        <h1 class="text-4xl font-bold mb-2">404</h1>
        <p class="text-gray-500">Piloto n√£o encontrado no grid.</p>
        <a routerLink="/" class="mt-4 inline-block text-racing-red hover:underline">Voltar ao Paddock</a>
      </div>
    </div>
  }
</div>

<app-footer></app-footer>