<app-navbar></app-navbar>

<div class="min-h-screen bg-pattern-dark p-4 pb-20 bg-fixed">
  <div class="max-w-4xl mx-auto space-y-8">

    <div class="flex justify-between items-end border-b border-gray-800 pb-6 animate-slide-down">
      <div>
        <h1 class="text-3xl md:text-5xl font-black text-white uppercase italic tracking-tighter">
          RIVAL<span class="text-racing-red">IDADE</span>
        </h1>
        <p class="text-gray-400 text-sm mt-1">Desafie pilotos para duelos 1x1 na pr√≥xima corrida.</p>
      </div>
      <button (click)="openChallengeModal()" class="bg-white text-black hover:bg-gray-200 font-black py-3 px-6 rounded-xl uppercase tracking-wider text-xs shadow-lg flex items-center gap-2 transition-transform transform hover:scale-105">
        <span>‚öîÔ∏è</span> Novo Desafio
      </button>
    </div>

    @if (isLoading) {
      <div class="flex justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-racing-red"></div>
      </div>
    } @else {

      @if (activeRivalries.length > 0) {
        <div class="animate-slide-up">
          <h3 class="text-racing-red font-bold uppercase tracking-widest text-sm mb-4 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-racing-red animate-pulse"></span> Na Pista (Pr√≥ximo GP)
          </h3>
          
          <div class="grid gap-4">
            @for (rivalry of activeRivalries; track rivalry.id) {
              @let opponent = getOpponent(rivalry);
              
              <div class="bg-gradient-to-r from-gray-900 to-black border border-racing-red/30 rounded-2xl p-6 relative overflow-hidden shadow-2xl group">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-10">
                  <span class="text-9xl font-black italic text-white">VS</span>
                </div>

                <div class="relative z-10 flex justify-between items-center">
                  
                  <div class="text-center">
                    <div class="w-16 h-16 rounded-full border-2 border-green-500 overflow-hidden mx-auto mb-2 shadow-[0_0_15px_rgba(34,197,94,0.3)] bg-gray-800 flex items-center justify-center">
                      @if (currentUser.profile_image_url) {
                        <img [src]="getPhotoUrl(currentUser.profile_image_url)" class="w-full h-full object-cover">
                      } @else {
                        <span class="text-white font-bold text-xl">{{ getInitials(currentUser.full_name) }}</span>
                      }
                    </div>
                    <span class="text-white font-bold text-sm">VOC√ä</span>
                  </div>

                  <div class="text-center">
                    <div class="text-2xl font-black text-racing-red italic">VS</div>
                    <span class="text-[10px] text-gray-500 uppercase tracking-widest bg-black/50 px-2 py-1 rounded mt-2 block">
                      Valendo Resenha
                    </span>
                  </div>

                  <div class="text-center">
                    <div class="w-16 h-16 rounded-full border-2 border-gray-600 overflow-hidden mx-auto mb-2 grayscale group-hover:grayscale-0 transition-all bg-gray-800 flex items-center justify-center">
                      @if (opponent.profile_image_url) {
                        <img [src]="getPhotoUrl(opponent.profile_image_url)" class="w-full h-full object-cover">
                      } @else {
                        <span class="text-white font-bold text-xl">{{ getInitials(opponent.full_name) }}</span>
                      }
                    </div>
                    <span class="text-gray-300 font-bold text-sm uppercase">{{ opponent.full_name.split(' ')[0] }}</span>
                  </div>

                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (pendingReceived.length > 0) {
        <div class="animate-slide-up" style="animation-delay: 0.1s;">
          <h3 class="text-yellow-500 font-bold uppercase tracking-widest text-sm mb-4 flex items-center gap-2 mt-8">
            <span>üì©</span> Convites Recebidos
          </h3>
          
          <div class="grid gap-3">
            @for (rivalry of pendingReceived; track rivalry.id) {
              @let opponent = rivalry.challenger;
              
              <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex items-center justify-between hover:border-yellow-500/50 transition-colors">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-full border border-gray-600 overflow-hidden bg-gray-800 flex items-center justify-center">
                    @if (opponent.profile_image_url) {
                      <img [src]="getPhotoUrl(opponent.profile_image_url)" class="w-full h-full object-cover">
                    } @else {
                      <span class="text-white font-bold">{{ getInitials(opponent.full_name) }}</span>
                    }
                  </div>
                  <div>
                    <h4 class="text-white font-bold text-sm">
                      <span class="text-racing-red">{{ opponent.full_name }}</span> te desafiou!
                    </h4>
                    <p class="text-gray-500 text-xs">Para o {{ rivalry.race?.name }}</p>
                  </div>
                </div>
                
                <div class="flex gap-2">
                  <button (click)="decline(rivalry.id)" class="p-2 rounded-lg bg-gray-800 text-red-500 hover:bg-red-900/20 border border-gray-700 transition" title="Recusar">‚úñ</button>
                  <button (click)="accept(rivalry.id)" class="px-4 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-500 shadow-lg transition text-xs uppercase tracking-wide">ACEITAR</button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <div class="animate-slide-up" style="animation-delay: 0.2s;">
        <h3 class="text-gray-500 font-bold uppercase tracking-widest text-sm mb-4 mt-10 border-b border-gray-800 pb-2">
          Cartel de Lutas
        </h3>

        @if (historyRivalries.length > 0) {
          <div class="space-y-2">
            @for (rivalry of historyRivalries; track rivalry.id) {
              @let opponent = getOpponent(rivalry);
              @let resultText = getWinnerText(rivalry);
              
              <div class="flex items-center justify-between p-4 rounded-lg bg-black/20 border border-gray-800 hover:bg-gray-900 transition-colors">
                
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full overflow-hidden opacity-70 bg-gray-800 flex items-center justify-center">
                    @if (opponent.profile_image_url) {
                      <img [src]="getPhotoUrl(opponent.profile_image_url)" class="w-full h-full object-cover">
                    } @else {
                      <span class="text-xs font-bold text-white">{{ getInitials(opponent.full_name) }}</span>
                    }
                  </div>
                  <div>
                    <div class="text-gray-300 font-bold text-xs">VS {{ opponent.full_name }}</div>
                    <div class="text-[10px] text-gray-600">{{ rivalry.race?.name }}</div>
                  </div>
                </div>

                <div class="text-right">
                  <span class="text-sm font-black italic block" [ngClass]="getWinnerClass(rivalry)">
                    {{ resultText }}
                  </span>
                  @if (rivalry.status === 'FINISHED') {
                    <span class="text-[9px] text-gray-500 uppercase">Margem: {{ rivalry.margin }} pts</span>
                  } @else {
                    <span class="text-[9px] text-gray-500 uppercase">Recusado/Cancelado</span>
                  }
                </div>

              </div>
            }
          </div>
        } @else {
          <div class="text-center py-10 border border-dashed border-gray-800 rounded-xl">
            <p class="text-gray-600 text-sm italic">Nenhum duelo finalizado ainda.</p>
          </div>
        }
      </div>

    }
  </div>
</div>

@if (showNewChallengeModal) {
  <div class="fixed inset-0 z-[200] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" (click)="showNewChallengeModal = false"></div>
    <div class="bg-racing-dark border border-racing-red/30 rounded-xl w-full max-w-md relative z-10 shadow-2xl animate-slide-up p-6">
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-racing-red/10 rounded-full flex items-center justify-center mx-auto mb-3 border border-racing-red/20 text-2xl">‚öîÔ∏è</div>
        <h3 class="text-2xl font-bold text-white uppercase italic">Escolha seu Oponente</h3>
        <p class="text-gray-400 text-xs mt-1">Desafie algu√©m para o pr√≥ximo GP.</p>
      </div>
      
      <div class="mb-4">
        <input type="text" [(ngModel)]="searchTerm" (keyup)="searchOponents()" placeholder="Buscar por nome..." 
               class="w-full bg-black text-white p-3 rounded-lg border border-gray-700 focus:border-racing-red outline-none text-sm">
      </div>

      <div class="mb-6">
        <label class="block text-gray-500 text-xs font-bold uppercase mb-2">Piloto Selecionado</label>
        <select [(ngModel)]="selectedOpponentId" class="w-full bg-black text-white p-4 rounded-xl border border-gray-700 focus:border-racing-red outline-none appearance-none cursor-pointer">
          <option [ngValue]="null">-- Selecione na lista --</option>
          @for (u of usersList; track u.id) {
            <option [value]="u.id">{{ u.full_name }}</option>
          }
        </select>
      </div>

      <div class="flex gap-3">
        <button (click)="showNewChallengeModal = false" class="flex-1 py-3 rounded-lg bg-gray-800 text-gray-300 font-bold hover:bg-gray-700 transition">CANCELAR</button>
        <button (click)="sendChallenge()" [disabled]="!selectedOpponentId || isCreating" class="flex-1 py-3 rounded-lg bg-racing-red text-white font-bold hover:bg-red-600 transition shadow-lg disabled:opacity-50">
          {{ isCreating ? 'ENVIANDO...' : 'DESAFIAR' }}
        </button>
      </div>

    </div>
  </div>
}

<app-footer></app-footer>